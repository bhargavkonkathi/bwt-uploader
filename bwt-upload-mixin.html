<script src="../pdfjs-dist/build/pdf.min.js"></script>
<script src="../pica/dist/pica.min.js"></script>
<script>
    // class Resizer {
    //     // Accepts the following options
    //     // {
    //     //   js:   true,
    //     //   wasm: true,
    //     //   cib:  true,
    //     //   ww:   true
    //     // };
    //     constructor(opts = ['js', 'wasm', 'ww', 'cib']) {
    //             this.image = image;
    //             this.resizer = pica({
    //                 features: opts
    //             })
    //         }
    //         // accepts only blob image type 
    //     resize(image) {
    //         return new Promise((resolve, reject) => {
    //             let finalImage = null;
    //             this.resizer.from(image, finalImage)
    //                 .then(result => pica.toBlob(result, 'image/jpeg', 0.90))
    //                 .then(final => {
    //                     resolve(finalImage);
    //                 });
    //         });
    //     }
    //     scaleImage(img, height) {
    //         let canvas = document.createElement('canvas');
    //         canvas.setAttribute('height', height);
    //         canvas.setAttribute('width', (height / img.height) * img.width);
    //         scale = (height / img.height).toFixed(2);
    //         var ctx = canvas.getContext('2d');
    //         scaledData = scaleDown(img, scale);
    //         ctx.scale(scaledData.remainingScale, scaledData.remainingScale);
    //         ctx.drawImage(scaledData.image, 2, 2);
    //         return canvas.toDataURL();
    //     }
    // }
    var resizer = (function() {
        'use strict';

        function Resize() {
            //
        }
        Resize.prototype = {
            init: function(outputQuality) {
                this.outputQuality = (outputQuality === 'undefined' ? 0.8 : outputQuality);
            },
            photo: function(file, maxSize, outputType, callback) {
                var _this = this;
                var reader = new FileReader();
                reader.onload = function(readerEvent) {
                    _this.resize(readerEvent.target.result, maxSize, outputType, callback);
                }
                reader.readAsDataURL(file);
            },
            resize: function(dataURL, maxSize, outputType, callback) {
                var _this = this;
                var image = new Image();
                image.onload = function(imageEvent) {
                    // Resize image
                    var canvas = document.createElement('canvas'),
                        width = image.width,
                        height = image.height;
                    if (width > height) {
                        if (width > maxSize) {
                            height *= maxSize / width;
                            width = maxSize;
                        }
                    } else {
                        if (height > maxSize) {
                            width *= maxSize / height;
                            height = maxSize;
                        }
                    }
                    canvas.width = width;
                    canvas.height = height;
                    canvas.getContext('2d').drawImage(image, 0, 0, width, height);

                    _this.output(canvas, outputType, callback);

                }
                image.src = dataURL;
            },
            output: function(canvas, outputType, callback) {
                switch (outputType) {
                    case 'file':
                        canvas.toBlob(function(blob) {
                            callback(blob);
                        }, 'image/jpeg', 0.8);
                        break;
                    case 'dataURL':
                        callback(canvas.toDataURL('image/jpeg', 0.8));
                        break;
                }
            }
        };
        return Resize;
    }());

    /* @polymerMixin */
    BWTUploadMixin = function(superClass) {
        return class extends superClass {
            static get properties() {
                return {
                    // private variable
                    error: {
                        type: Object,
                        value: {
                            val: false,
                            msg: ''
                        },
                        notify: true,
                        reflectToAttribute: true
                    },
                    // private variable
                    file: {
                        type: Object,
                        value: {},
                        notify: true
                    },
                    /**
                     * The type of placeholder, accepts either one of two arguments; square or circle
                     **/
                    theme: {
                        type: String,
                        value: 'circle',
                        notify: true,
                        reflectToAttribute: true
                    },
                    // url of the image to be displayed, this can be used mixed with the placeholder
                    image: {
                        type: String,
                        value: '',
                        notify: true,
                        reflectToAttribute: true
                    },
                    /**
                     * location of the placeholder image
                     **/
                    placeholder: {
                        type: String,
                        value: '/bower_components/bwt-uploader/images/placeholder.png',
                        notify: true
                    },
                    placeHolderRemoved: {
                        type: Boolean,
                        value: false,
                        notify: true
                    },
                    customClass: {
                        type: Boolean,
                        value: false,
                        notify: true
                    },
                    outputType: {
                        type: String,
                        value: 'dataURL'
                    }
                }
            }
            _hasWrongMimeType(file, acceptedFileTypes) {
                if (!acceptedFileTypes.includes(file.type))
                    throw new Error('Invalid file type, please upload an accepted file type');
            }
            _hasMoreThanOneFile(files) {
                if (files.length > 1)
                    throw new Error('You can only upload one file at a time');
            }
            _validateFile(files) {
                    try {
                        this._hasMoreThanOneFile(files);
                        this._hasWrongMimeType(files[0], this.acceptedFileTypes);
                        this._hasExceededMaximumFileSize(files[0]);
                    } catch (e) {
                        this.error = e;
                    }
                }
                // Only applies images that are captured or less than minute
            _isRecentImage(file) {
                if (file && file.lastModifiedDate) {
                    var diiference = Math.round(new Date() - file.lastModifiedDate) / 60000;
                    if (diiference <= 1) return true;
                    else return false;
                }
            }

            _hasExceededMaximumFileSize(file) {
                var _isRecentImage = this._isRecentImage(file);
                if (file.size > (this.maxFileSize * 1024) && !_isRecentImage)
                    throw new Error('The uploaded file exceeds ' + this.maxFileSize + ' KB')
            }
            _uploadFile(files) {
                this._validateFile(files);
                if (this.error.val) return;
                this.set('file', files[0]);
                this.set('file.progress', 20);
                this.notifyPath('file.progress');
                this.file.error = false;
                this.file.complete = false;
                this._startPreviewAndAjax(this.file);
            }
            async _startPreviewAndAjax(file) {
                // switch (file.type) {
                //   case :

                //     break;

                //   default:
                //     break;
                // }
                try {
                    if (file.type === 'application/pdf') {
                        this.set('file.progress', 40);
                        this.notifyPath('file.progress');
                        let image = await this._getDocumentPreview(file);
                        this._uploadPdf(file, image);
                    } else {
                        this.$.preview._createImagePreview(file)
                            .then(function(img) {
                                return this._createImageFile(img);
                            }.bind(this))
                            .then(function(image) {
                                var newImage = image.src;
                                if (this.resize && image.height > this.height) {
                                    var resize = new resizer();
                                    resize.init();
                                    var _this = this;
                                    newImage = resize.photo(file, this.height, 'dataURL', function(dataURL) {
                                        _this.set('file.progress', 60);
                                        _this.notifyPath('file.progress');
                                        _this._upload(dataURL);
                                    });
                                    // checking if file size of new image is bigger than the original
                                } else {
                                    this.set('file.progress', 60);
                                    this.notifyPath('file.progress');
                                    this._upload(newImage);
                                }
                            }.bind(this));
                    }
                } catch (e) {
                    console.error(e);
                    this.set('file.error', true);
                    this.notifyPath('file.error');
                    this.error = 'File Couldn\'t be uploaded';
                }
            }
            async _getDocumentPreview(file) {
                try {
                    this.set('file.progress', 60);
                    this.notifyPath('file.progress');
                    PDFJS.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/1.7.246/pdf.worker.min.js';
                    // there is no proper way to load this thing other than a cdn
                    let buffer = await this._createArrayBufferFie(file);
                    let pdf = await PDFJS.getDocument(buffer);
                    let page = await pdf.getPage(1);
                    var scale = 0.36;
                    var viewport = page.getViewport(scale);
                    var canvas = document.createElement('canvas');
                    var context = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;

                    var task = page.render({
                        canvasContext: context,
                        viewport: viewport
                    });
                    let response = await task.promise;
                    this.image = canvas.toDataURL("image/jpeg");
                    this.$.preview._updateImage(this.placeholder, this.image);
                    // hacky but it works, need to figure out why image wont update on binding
                } catch (error) {
                    console.error(error);
                    throw new Error('Code Error');
                }
            }
            _createImageFile(image) {
                var img = new Image();
                img.src = image;
                return new Promise(function(resolve, reject) {
                    img.onload = resolve(img);
                });
            }
            _createArrayBufferFie(file) {
                var fileReader = new FileReader();
                return new Promise(function(resolve, reject) {
                    fileReader.onload = function(ev) {
                        resolve(fileReader.result);
                    }
                    fileReader.readAsArrayBuffer(file);
                });
            }
            _upload(file, img) {
                this.set('file.progress', 80);
                this.notifyPath('file.progress');
                var ajax = this.$.ajaxElement;
                ajax.contentType = "application/json";
                ajax.body = this.body;
                ajax.body.file = file;
                if (img) ajax.body.thumbnail = img;
                this.$.ajaxElement.generateRequest();
            }
            _uploadPdf(file, img) {
                var fileReader = new FileReader();
                fileReader.onload = function(ev) {
                    this._upload(ev.target.result, img);
                }.bind(this);
                fileReader.readAsDataURL(file);
                this.set('file.progress', 80);
                this.notifyPath('file.progress');
            }
        }
    };
</script>